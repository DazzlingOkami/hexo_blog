---
title: SWD采样时序
author: WangGaojie
---

最近在工作中遇到一个技术问题，在翻看ARM的一份技术手册《Arm Debug Interface Architecture Specification》，看到SWD章节时，我突然有个疑惑，SWD的DIO信号到达是在CLK的上升沿采样还是下降沿采样？

我反复阅读了文档，似乎并没有明确的描述。只有一张描述时序的图：
![swd_timing.png](swd.png)

很有意思，根据这个图来看，应该是Host在上升沿输出信号，Host在下降沿读取信号。

为了确保理解有遗漏的地方，我把文档放到了豆包AI中去分析，让它看看这个时序是怎么样的。
豆包AI帮我解读了文档中SWD相关的部分：

该文档围绕Arm Debug Interface v5展开，其中SWD协议是重要内容，涵盖协议概述、操作、接口等方面。它是一种同步串行接口协议，具有多版本、支持多种操作等特点，在调试中起着关键作用。
1. **协议概述**
    - **基本操作**：采用单双向数据连接和独立时钟同步传输数据 ，一次操作包含数据包请求、确认响应和数据传输（按需）三个阶段。传输完成后，主机需进行特定操作以确保数据能顺利通过SW - DP。
    - **协议版本**：v1是点对点架构，存在物理连接复杂等缺点；v2是多-drop架构，支持多设备连接，向后兼容，支持设备断电，但与v1在启动状态和休眠状态上存在兼容性问题。
    - **其他特性**：包括线路反转（防止信号冲突，时长由DLCR.TURNROUND控制 ）、空闲周期（主机完成事务后需插入空闲周期或开始新事务 ）、位顺序（数据传输LSB先）、奇偶校验（对数据包请求和数据传输阶段进行偶校验）以及多-drop限制（设备需唯一ID，存在配置和自动检测限制 ）。
2. **协议操作**
    - **各种响应情况**：成功写操作（OK响应）包括8位写数据包请求、3位OK确认响应和33位WDATA数据传输阶段；成功读操作类似，只是数据传输方向相反。WAIT响应表示SW - DP无法立即处理请求，FAULT响应表示有错误发生，协议错误响应针对多种错误情况。
    - **特殊情况处理**：SW - DP可实现写缓冲，能接受写操作，但存在相关限制。此外，还介绍了目标和主机的响应总结，以及SWD协议操作中的各种状态变化和数据传输规则。
3. **接口相关**
    - **接口概述**：使用单双向数据引脚SWDIO和时钟引脚SWCLK，支持主机和目标驱动信号，时钟可异步，空闲时可停止。目标需100KΩ上拉电阻确保线路状态已知。
    - **连接与复位**：调试器需进行线路复位序列以确保连接正常，复位后特定操作可使接口退出复位状态。SWD协议版本2有特定的目标选择协议，涉及写TARGETSEL寄存器和读DPIDR寄存器等操作 。 

豆包AI都已经看到了位顺序是LSB这些细节了，但是它任然没有找到找到SWD的DIO信号到达是在CLK的上升沿采样还是下降沿采样。

所以我又进一步明确问题：SWD协议是上升沿采样还是下降沿采样？
AI这次还联网查询了一下：

SWD协议中，数据在SWDIO上传输时，目标设备在SWCLK的上升沿进行采样。这一采样方式在文档及相关资料中均有明确阐述，是SWD协议数据传输机制的重要组成部分。 
- **数据采样沿的明确规定**：在文档中虽未直接提及SWD协议是上升沿采样还是下降沿采样，但参考其他权威资料，如CSDN博客文章《SWD(一) 杂谈》明确指出从相关章节可以看到是上升沿采样。并且在“SWD协议操作”部分描述数据传输过程时，虽未强调采样沿，但从信号传输的逻辑和常见的SWD协议实现来看，上升沿采样符合其数据传输的时序要求。
 - **与协议其他部分的关联性**：SWD协议的数据包请求、确认响应和数据传输阶段的操作，都依赖于准确的采样时刻来保证数据的正确传输。上升沿采样确保了在时钟信号的特定时刻，目标设备能稳定地获取总线上的数据，与协议中对数据传输的奇偶校验、数据包格式等规定相互配合，共同保障数据传输的准确性和稳定性。 

所以AI也认为文档中没有明确说明。

获取我们需要第三方的代码来佐证一下：
https://github.com/blackmagic-debug/blackmagic/blob/main/src/platforms/common/swdptap.c
根据这段代码中的注释以及函数实现来看，主机端在时钟下降沿输出数据，在时钟上升沿采集数据。

在看看Raspberry Pi的代码：
https://github.com/raspberrypi/debugprobe/blob/master/src/probe.pio
这段代码中的注释和实现同样表明了主机端在时钟下降沿输出数据，在时钟上升沿采集数据。

还有CMSIS-DAP的源码中SW_DP.c文件的实现来看，主机端在时钟下降沿输出数据，在时钟上升沿采集数据。

所以问题是ARM的文档中配图是不是存在错误?还是说它就是一个示意图，没有明确说明。

将问题交给DeepSeek分析一下，我的问题是：ARM芯片的SWD调试协议中DIO在CLK上升沿还是下降沿采样？
它思考了43秒，给出了标题：ARM SWD调试协议DIO采样沿分析
![deepseek-swd](deepseek-swd.png)

DeepSeek的回答简直无可挑剔！

目前的AI工具都太强大了，可以帮助分析很多问题。但是目前AI的代码能力仍然有限，只能用于输出几百行规模的代码，不能用于分析复杂的需求。或许不久后就有能够生成几千行甚至上万行代码的能力，那时候才是解放生产力的时代。

